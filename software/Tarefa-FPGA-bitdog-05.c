 #include <stdio.h>
 #include <math.h> 
 #include <stdlib.h>
 #include <string.h>
 #include "ssd1306.h"
 #include "ssd1306_fonts.h"
 #include "pico/stdlib.h"
 #include "hardware/i2c.h"
 #include "lora_RFM95.h"

// ==========================================================
// ===         PINAGEM E CONFIGURAÇÕES GLOBAIS            ===
// ==========================================================

// Mapeamento dos pinos do rádio LoRa para o Raspberry Pi Pico.
// Certifique-se de que estes pinos correspondem à sua fiação.
#define PIN_MISO 16
#define PIN_CS   17
#define PIN_SCK  18
#define PIN_MOSI 19
#define PIN_RST  20
#define PIN_DIO0 8  // Pino de interrupção (essencial para a biblioteca)

// Frequência de operação em Hz.
// ATENÇÃO: Use a frequência correta para sua região!
// 915E6 para Américas (US915)
// 868E6 para Europa (EU868)
// 433E6 para Ásia (AS433)
#define LORA_FREQUENCY 915E6

// Intervalo entre os envios em milissegundos
#define SEND_INTERVAL_MS 10000 // 10 segundos

// Estrutura de dados para recepção
typedef struct {
    int16_t temperatura;
	int16_t umidade;
} dados;

struct repeating_timer timer;

int cont = 0;

void imprimedisplay(float, float);

bool repeating_timer_callback(struct repeating_timer *t) {
	if(cont < 3){
		ssd1306_SetCursor((cont + 4)*15, 6 + 15);
		ssd1306_WriteString(".", Font_16x15, White);
	}
	if(cont < 6 && cont > 2){
		ssd1306_SetCursor((cont + 1)*15, 6 + 15);
		ssd1306_WriteString(" ", Font_16x15, White);
	}
	if(cont > 5){
		cont = -1;
	}
	cont++;
	ssd1306_UpdateScreen();

	return true;

}

// imagem de backgroud para tarefa
void func_backgoud()
{

    const uint8_t _bits[] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x06, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x0c, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x03, 0xc9, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x1f, 0xc9, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x03, 0xc9, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x81, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x81, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0xe3, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x03, 0x80, 0xc0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x03, 0x20, 0x60, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x06, 0x70, 0x20, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x09, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x04, 0xd1, 0x10, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x19, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0c, 0x73, 0x10, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x23, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0c, 0x26, 0x10, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x4c, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0c, 0x0c, 0x10, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x98, 0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x0c, 0x1b, 0x90, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x90, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x04, 0x32, 0x90, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x20, 0x04, 0x80, 0x00, 0x00, 0x00, 0x00, 0x20, 0x06, 0x22, 0x90, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x20, 0x04, 0x80, 0x00, 0x00, 0x00, 0x00, 0x20, 0x06, 0x03, 0xa0, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x20, 0x04, 0x80, 0x00, 0x00, 0x00, 0x00, 0x31, 0x03, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x20, 0x04, 0x80, 0x00, 0x00, 0x00, 0x00, 0x11, 0x81, 0x80, 0xc0, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x20, 0x04, 0x80, 0x00, 0x00, 0x00, 0x00, 0x10, 0x80, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x10, 0x08, 0x80, 0x00, 0x00, 0x00, 0x00, 0x18, 0xf0, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x98, 0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x20, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x8c, 0x31, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x43, 0xc2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x20, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xef, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

    ssd1306_DrawBitmap(0, 0, _bits, 128, 64, White);
    ssd1306_UpdateScreen();
}

 void aguardar(){

	ssd1306_Fill(Black);
	ssd1306_SetCursor( 7, 0 + 6);
    ssd1306_WriteString("Aguardando", Font_16x15, White);
	ssd1306_SetCursor( 7, 6 + 15);
	ssd1306_WriteString("dados", Font_16x15, White);
	ssd1306_UpdateScreen();

	// Ativa o timer (200 ms)
    add_repeating_timer_ms(200, repeating_timer_callback, NULL, &timer);


	sleep_ms(10000);
 }
 
 void iniciar(){

    stdio_init_all();

    ssd1306_Init();

	ssd1306_Fill(Black);
    // 1. Configurar o rádio LoRa
    lora_config_t lora_cfg = {
        .spi_instance = spi0, // Usando a interface SPI0
        .pin_miso = PIN_MISO,
        .pin_cs = PIN_CS,
        .pin_sck = PIN_SCK,
        .pin_mosi = PIN_MOSI,
        .pin_rst = PIN_RST,
        .pin_dio0 = PIN_DIO0,
        .frequency = LORA_FREQUENCY
    };


	// 2. Inicializar o módulo LoRa
    printf("Inicializando o modulo LoRa na frequencia %.0f Hz...\n", (float)LORA_FREQUENCY);
	ssd1306_SetCursor( 7, 0 + 6);
    ssd1306_WriteString("Inic LoRa na freq:", Font_6x8, White);
	ssd1306_SetCursor( 7, 6 + 11);
	ssd1306_UpdateScreen();
	sleep_ms(500);

	char message[6];
    snprintf(message, sizeof(message), "%.1f", (float)LORA_FREQUENCY/1000000);
	ssd1306_WriteString(strcat(message, "MHz"), Font_6x8, White);

	ssd1306_UpdateScreen();
	sleep_ms(500);

	ssd1306_SetCursor( 7, 6 + 11 + 11);
    if (!lora_init(lora_cfg)) {
        printf("[ERRO] Falha ao inicializar o modulo LoRa. Verifique a fiacao e a versao do chip (deve ser 0x12).\n");
		ssd1306_WriteString("ERRO - mod LoRa.", Font_6x8, White);
		ssd1306_UpdateScreen();
		
        // Trava a execução se a inicialização falhar
        while (1);
    }
    printf("[SUCESSO] Modulo LoRa inicializado com sucesso!\n\n");

	ssd1306_WriteString("[SUCESSO] - mod LoRa.", Font_6x8, White);
	ssd1306_UpdateScreen();
	sleep_ms(1000);

	ssd1306_Fill(Black);
	ssd1306_UpdateScreen();

	// 3. Coloca o rádio no modo RX contínuo (MODE_RX_CONTINUOUS = 0x05), permitindo que ele fique sempre escutando o canal até receber um pacote
	lora_start_rx_continuous();

 }
 // função responsavel por atualizar o display
#include <stdlib.h>
#include <math.h>

void imprimedisplay(float temp, float umid) {

    // --- SEPARA A PARTE INTEIRA E FRACIONÁRIA ---
    int temp_int = (int)temp;                              // parte inteira
    int temp_frac = (int)((fabsf(temp) - abs(temp_int)) * 100 + 0.5f); // duas casas decimais (com arredondamento)

    int umid_int = (int)umid;
    int umid_frac = (int)((fabsf(umid) - abs(umid_int)) * 100 + 0.5f);

    // --- BUFFERS PARA CONVERSÃO EM STRING ---
    char temp_i[5], temp_f[3];
    char umid_i[5], umid_f[3];

    sprintf(temp_i, "%d", temp_int);
    sprintf(temp_f, "%02d", temp_frac);  // sempre 2 dígitos (ex: “05”)
    sprintf(umid_i, "%d", umid_int);
    sprintf(umid_f, "%02d", umid_frac);

    // --- LIMPA E DESENHA ---
    ssd1306_FillRectangle(0+4, 0+6, 60 - 4, 0 + 16, White);
    ssd1306_SetCursor(7, 8);
    ssd1306_WriteString("Temp. C", Font_6x8, Black);

    ssd1306_FillRectangle(64+4, 0+6, 127 - 4, 0 + 16, White);
    ssd1306_SetCursor(70, 8);
    ssd1306_WriteString("Umidade %%", Font_6x8, Black);

    // --- TEMPERATURA ---
    ssd1306_SetCursor(24, 23);
    ssd1306_WriteString(temp_i, Font_16x24, White);
	ssd1306_SetCursor(32, 46);
    ssd1306_WriteString(",", Font_16x15, White);
    ssd1306_WriteString(temp_f, Font_16x15, White);

    // --- UMIDADE ---
    ssd1306_SetCursor(29 + 63, 23);
    ssd1306_WriteString(umid_i, Font_16x24, White);
	ssd1306_SetCursor(34 + 63, 46);
    ssd1306_WriteString(",", Font_16x15, White);
    ssd1306_WriteString(umid_f, Font_16x15, White);

    // --- CAIXAS E FUNDO ---
    ssd1306_DrawRectangle(64, 0, 127, 63, White);
    ssd1306_DrawRectangle(0, 0, 60, 63, White);

    func_backgoud();
    ssd1306_UpdateScreen();
}

 
int main() {

	dados recebido;

	bool start = 1;

    iniciar();
	aguardar();

    while (1)
    {
	int len = lora_receive_bytes((uint8_t*)&recebido, sizeof(recebido));

        if (len == sizeof(recebido)) {
			if (start){
				cancel_repeating_timer(&timer);
				ssd1306_Fill(Black);
			}
			imprimedisplay((float)recebido.temperatura/100, (float)recebido.umidade/100);
			start = 0;
        }

    }    
    
    return 0;
}
 